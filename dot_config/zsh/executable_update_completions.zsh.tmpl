#!/usr/bin/env zsh

# Initialize environment for standalone execution
{{ if eq .chezmoi.os "darwin" -}}
[[ -f /opt/homebrew/bin/brew ]] && eval "$(/opt/homebrew/bin/brew shellenv)"
{{- end }}
[[ -f "$HOME/.local/bin/mise" ]] && eval "$($HOME/.local/bin/mise activate zsh)"

COMPDIR="$HOME/.config/zsh/completions"
LIBDIR="$HOME/.config/zsh/lib"
mkdir -p "$COMPDIR" "$LIBDIR"

echo -e "\033[1;34mUpdating completions...\033[0m"

gen() {
  local tool="$1"
  local cmd="$2"
  local file="$COMPDIR/_$tool"
  local bin_path

  bin_path=$(command -v "$tool") || return

  # Check if we need to update:
  # 1. File doesn't exist
  # 2. Binary is newer than the cached completion
  if [[ ! -f "$file" || "$bin_path" -nt "$file" ]]; then
    local tmp="/tmp/gen_comp_zsh_$$"
    (eval "$cmd" 2>&1 || true) | cat >"$tmp"

    if [ -s "$tmp" ]; then
      # Add #compdef if the tool's output missed it
      if ! head -n 1 "$tmp" | grep -q "^#compdef"; then
        echo "#compdef $tool" >"$file"
        cat "$tmp" >>"$file"
      else
        cat "$tmp" >"$file"
      fi

      # Clean line endings
      {{ if eq .chezmoi.os "darwin" -}}
      sed -i '' 's/\r//g' "$file"
      {{- else -}}
      sed -i 's/\r//g' "$file"
      {{- end }}
      echo "  \033[0;32m✓ $tool (updated)\033[0m"
    fi
    rm -f "$tmp"
  else
    echo "  \033[0;34m- $tool (up to date)\033[0m"
  fi
}

BUN_BREW_COMP="/opt/homebrew/share/zsh/site-functions/_bun"
LOCAL_BUN_COMP="$COMPDIR/_bun"

if [[ -s "$BUN_BREW_COMP" ]]; then
  if [[ ! -f "$LOCAL_BUN_COMP" || "$BUN_BREW_COMP" -nt "$LOCAL_BUN_COMP" ]]; then
    cp "$BUN_BREW_COMP" "$LOCAL_BUN_COMP"
    echo "  \033[0;32m✓ bun (updated from brew)\033[0m"
  else
    echo "  \033[0;34m- bun (up to date)\033[0m"
  fi
else
  gen "bun" "bun completions zsh"
fi

gen "bat" "bat --completion zsh"
gen "bw" "bw completion --shell zsh"
gen "cargo" "rustup completions zsh cargo"
gen "chezmoi" "chezmoi completion zsh"
gen "delta" "delta --generate-completion zsh --paging never"
gen "deno" "deno completions zsh"
gen "gh" "gh completion -s zsh"
gen "glow" "glow completion zsh"
gen "gum" "gum completion zsh"
gen "jj" "jj util completion zsh"
gen "just" "just --completions zsh"
gen "mise" "mise completion zsh"
gen "opencode" "opencode completion"
gen "pnpm" "pnpm completion zsh"
gen "rg" "rg --generate complete-zsh"
gen "ruff" "ruff generate-shell-completion zsh"
gen "rustup" "rustup completions zsh"
gen "sg" "sg completions zsh"
gen "starship" "starship completions zsh"
gen "typst" "typst completions zsh"
gen "uv" "uv generate-shell-completion zsh"
gen "vhs" "vhs completion zsh"
gen "xh" "xh --generate complete-zsh"
gen "yq" "yq completion zsh"

# --- Static Config Generation (Performance) ---
SK_BIN=$(command -v sk)
SK_INIT="$LIBDIR/sk_init.zsh"

if [[ -n "$SK_BIN" ]]; then
  if [[ ! -f "$SK_INIT" || "$SK_BIN" -nt "$SK_INIT" ]]; then
    # Generate bindings, remove Tab hijack, clean line endings
    sk --shell=zsh --shell-bindings | sed "/bindkey '\^I'/d" | sed 's/\r//g' >"$SK_INIT"
    echo "  \033[0;32m✓ sk (updated bindings)\033[0m"
  else
    echo "  \033[0;34m- sk (up to date)\033[0m"
  fi
fi

# Clear all possible completion caches
rm -f "$HOME"/.zcompdump*(N)
rm -f "$ZDOTDIR"/.zcompdump*(N)
[[ -n "$ZSH_COMPDUMP" ]] && rm -f "$ZSH_COMPDUMP"

rm -f "$HOME"/.zcompdump*(N)
rm -f "$ZDOTDIR"/.zcompdump*(N)
[[ -n "$ZSH_COMPDUMP" ]] && rm -f "$ZSH_COMPDUMP"

echo -e "\n\033[1;34mMaintenance complete. Run 'reload' if needed.\033[0m"
# vim: ft=zsh
