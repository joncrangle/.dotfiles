# NOTE:
#   (`-')   (`-').-> (`-').->
#   ( OO).->( OO)_   (OO )__
# ,(_/----.(_)--\_) ,--. ,'-'
# |__,    |/    _ / |  | |  |
#  (_/   / \_..`--. |  `-'  |
#  .'  .'_ .-._)   \|  .-.  |
# |       |\       /|  | |  |
# `-------' `-----' `--' `--'
# ##############################
# #      ZSH CONFIGURATION     #
# ##############################

HISTORY_IGNORE="(ls|cd|pwd|zsh|exit|cd ..)"
HISTSIZE=10000
SAVEHIST=10000
LISTMAX=1000
COREPACK_ENABLE_AUTO_PIN=0

{{ if eq .chezmoi.os "darwin" }}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ end }}
{{ if eq .chezmoi.os "linux" }}
source "/usr/share/zsh-antidote/antidote.zsh"
{{ else }}
source "$HOMEBREW_DIR/opt/antidote/share/antidote/antidote.zsh"
{{ end }}
antidote load

{{ if eq .chezmoi.os "linux" }}
FPATH="/usr/share/zsh/site-functions:${FPATH}"
{{ else }}
FPATH="$HOMEBREW_DIR/share/zsh/site-functions:${FPATH}"
{{ end }}

function zvm_config() {
  ZVM_VI_SURROUND_BINDKEY=s-prefix
  ZVM_VI_HIGHLIGHT_FOREGROUND=#cdd6f4
  ZVM_VI_HIGHLIGHT_BACKGROUND=#45475a
  ZVM_VI_HIGHLIGHT_EXTRASTYLE=bold
  ZVM_INIT_MODE=sourcing
}

source "$ZDOTDIR/options.zsh"
source "$ZDOTDIR/aliases.zsh"
source "$ZDOTDIR/banner.zsh"

eval "$(mise activate zsh)"

autoload -Uz add-zle-hook-widget

eval "$(starship init zsh)"

set-long-prompt() {
  PROMPT="$(starship prompt)"
  RPROMPT=""
}

set-short-prompt() {
  PROMPT="$(starship module character)"
  RPROMPT=$'%{\e[999C\e[8D%}%F{8}%*%f '
}

precmd_functions+=(set-long-prompt)

function transient-line-finish() {
  set-short-prompt
  zle .reset-prompt 2>/dev/null
}
zle -N transient-line-finish

# Trap: handle Ctrl+C
function transient-int() {
  set-short-prompt
  zle .reset-prompt 2>/dev/null
  return 130
}

# Custom Keymap Logic (Safe Hook)
# We use a separate function name to avoid naming collisions
function my-starship-keymap-select() {
  if [[ ${KEYMAP} == vicmd ]] || [[ $1 = "block" ]]; then
    echo -ne "\e[1 q"
    STARSHIP_KEYMAP=vicmd
  elif [[ ${KEYMAP} == main ]] || [[ ${KEYMAP} == viins ]] || [[ ${KEYMAP} = "" ]] || [[ $1 = "beam" ]]; then
    echo -ne "\e[5 q"
    STARSHIP_KEYMAP=viins
  fi
  zle .reset-prompt
}

# ZVM Hooks
zvm_after_init_commands+=(
  # 1. Bind the transient finish widget safely
  'zle -N zle-line-finish transient-line-finish'

  # 2. Bind the keymap select hook using the safe helper
  # This prevents "maximum nested function level" errors
  'autoload -Uz add-zle-hook-widget'
  'add-zle-hook-widget zle-keymap-select my-starship-keymap-select'

  # 3. Fix line init cursors
  'function zle-line-init() {
    zle -K viins
    echo -ne "\e[5 q"
  }
  zle -N zle-line-init'

  # 4. FZF source
  'source <(fzf --zsh)'
)

# Apply the Ctrl+C trap
trap 'transient-int' INT

zstyle ':fzf-tab:*' default-color ""
zstyle ':fzf-tab:*' use-fzf-default-opts yes

bindkey -M vicmd ":" undefined-key

source <(COMPLETE=zsh jj)
source <(mise completion zsh)
# vim: ft=zsh
